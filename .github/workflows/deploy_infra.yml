name: Deploy Infra

on:
  workflow_dispatch: # Manual trigger only

jobs:
  deploy-infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest

    environment:
      name: infra
      url: ${{ steps.deploy.outputs.url }}
    # Requires manual approval via 'infra' environment protection rules

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          pip install ansible
          ansible --version

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install Ansible collections and roles
        run: |
          # Create directories if they don't exist
          mkdir -p ~/.ansible/collections
          # Install requirements
          ansible-galaxy install -r requirements.yml --force
          ansible-galaxy collection install -r requirements.yml --force

      - name: Read deployment_vars.json with jq
        id: read_vars
        run: |
          DOMAIN_NAME=$(jq -r '.domain_name' deployment_vars.json)
          ANSIBLE_USER=$(jq -r '.ansible_user' deployment_vars.json)
          echo "DOMAIN_NAME=$DOMAIN_NAME" >> $GITHUB_ENV
          echo "ANSIBLE_USER=$ANSIBLE_USER" >> $GITHUB_ENV
          echo "DOMAINNAME=$DOMAIN_NAME" >> $GITHUB_ENV

      - name: Validate Ansible syntax
        run: |
          ansible-playbook --syntax-check -i "$DOMAINNAME," -u "$ANSIBLE_USER" deploy_playbook.yml

      - name: Run Ansible playbook
        run: |
          ansible-playbook \
            -e DOMAIN_NAME="$DOMAIN_NAME" \
            -e ANSIBLE_USER="$ANSIBLE_USER" \
            deploy_infra_playbook.yml \
            --diff \
            --verbose
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
          ANSIBLE_FORCE_COLOR: "1"
          ANSIBLE_STDOUT_CALLBACK: yaml

      - name: Post-deployment health check
        if: success()
        run: |
          echo "Deployment completed successfully!"
          # Add any post-deployment validation commands here

  test-syntax:
    name: Test Playbook Syntax
    runs-on: ubuntu-latest
    # Run on PRs and pushes
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          pip install ansible
          ansible --version

      - name: Install Ansible dependencies
        run: |
          ansible-galaxy install -r requirements.yml --force
          ansible-galaxy collection install -r requirements.yml --force

      - name: Check playbook syntax
        run: |
          ansible-playbook --syntax-check -i "$DOMAINNAME," -u "$ANSIBLE_USER" deploy_infra_playbook.yml
